name: CI/CD for Market-react-ecommerce-main using PM2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Use NVM Node Environment
        run: |
          export NVM_DIR="$HOME/.nvm"
          source "$NVM_DIR/nvm.sh"
          nvm use 18

          # Install deps & build
          cd /var/www/Market-react-ecommerce-main
          npm install
          CI='' npm run build

          # Start or restart PM2 process
          if pm2 list | grep -q "react-app"; then
            pm2 restart react-app
          else
            pm2 start npm --name "react-app" -- run start-server
          fi

          pm2 save

          # Enable PM2 startup on reboot
          sudo su -c "env PATH=$PATH:/home/ubuntu/.nvm/versions/node/$(nvm version)/bin pm2 startup systemd -u ubuntu --hp /home/ubuntu"
